name: RDP Gaming Loop (DirectX Auto-Fix)

on:
  workflow_dispatch:
    inputs:
      runtime_minutes: { description: "Minutes per loop (Max 355)", required: false, default: "355" }
      cycles:          { description: "Loops Remaining", required: false, default: "0" }

jobs:
  run-rdp:
    runs-on: windows-latest
    steps:
      - name: 1. Setup Tailscale
        run: |
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          Invoke-WebRequest "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "ts.exe"
          Start-Process -FilePath "ts.exe" -ArgumentList "/quiet" -Wait
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" --hostname="github-rdp"

      - name: 2. Setup Rclone & User
        env:
          RCLONE_CONF: ${{ secrets.RCLONE_CONFIG_DATA }}
        run: |
          $u = "RDPUser"; $p = "Dragon@12345"; $sec = ConvertTo-SecureString $p -AsPlainText -Force
          New-LocalUser -Name $u -Password $sec -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $u
          Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name fDenyTSConnections -Value 0
          Invoke-WebRequest https://downloads.rclone.org/rclone-current-windows-amd64.zip -OutFile rclone.zip
          Expand-Archive rclone.zip -DestinationPath C:\
          Set-Content -Path "C:\rclone.conf" -Value $env:RCLONE_CONF

      - name: 3. Auto-Install DirectX (Fix Cabinet Error)
        run: |
          # This fixes the "Cabinet file cannot be trusted" error automatically
          Set-Service -Name CryptSvc -StartupType Automatic
          Start-Service CryptSvc
          Write-Host "Installing DirectX Components..."
          Invoke-WebRequest -Uri "https://download.microsoft.com/download/1/7/1/1718CCC4-6315-4D8E-9543-8E28A4E18C4C/dxwebsetup.exe" -OutFile "dxsetup.exe"
          Start-Process -FilePath "dxsetup.exe" -ArgumentList "/Q" -Wait

      - name: 4. Restore Saves
        run: |
          $rclone = Get-ChildItem -Path "C:\rclone-v*-windows-amd64\rclone.exe" | Select-Object -First 1
          $dest = "C:\Users\RDPUser\Desktop\MASTER_SAVE_SYNC"
          if (!(Test-Path $dest)) { New-Item -ItemType Directory -Path $dest }
          & $rclone.FullName --config "C:\rclone.conf" copy "mycloud:RDP_Backups" "$dest" || cmd /c "exit /b 0"

      - name: 5. Keep Alive
        run: Start-Sleep -Seconds (${{ github.event.inputs.runtime_minutes }} * 60)

      - name: 6. Final Backup & Loop
        if: always()
        env:
          GH_TOKEN: ${{ secrets.MY_LOOP_TOKEN }}
        run: |
          $rclone = Get-ChildItem -Path "C:\rclone-v*-windows-amd64\rclone.exe" | Select-Object -First 1
          $src = "C:\Users\RDPUser\Desktop\MASTER_SAVE_SYNC"
          & $rclone.FullName --config "C:\rclone.conf" sync "$src" "mycloud:RDP_Backups" || cmd /c "exit /b 0"
          $next = [int]"${{ github.event.inputs.cycles }}" - 1
          if ($next -ge 0) {
            $url = "https://api.github.com/repos/${{ github.repository }}/actions/workflows/rdp-loop.yml/dispatches"
            $body = @{ref="${{ github.ref_name }}";inputs=@{runtime_minutes="${{ github.event.inputs.runtime_minutes }}";cycles="$next"}} | ConvertTo-Json
            Invoke-RestMethod -Method Post -Uri $url -Headers @{ Authorization = "Bearer $env:GH_TOKEN" } -Body $body
          }
